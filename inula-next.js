import{Store as w}from"@openinula/store";"global"in w||(typeof window<"u"?w.global=window:typeof global<"u"?w.global=global:w.global={});"document"in w||typeof document<"u"&&(w.document=document);var r={...w,delegatedEvents:new Set};function Q(o){r.global=o}function R(o){r.document=o}function g(o,t){return!t||o.length!==t.length?!1:o.every((e,n)=>!(e instanceof Object)&&t[n]===e)}var m={Comp:0,For:1,Cond:2,Env:3,Exp:4,Snippet:5,Try:6},l=class{_$dlNodeType;constructor(t){this._$dlNodeType=t}get _$el(){return l.toEls(this._$nodes)}static toEls(t){let e=[];return this.loopShallowEls(t,n=>{e.push(n)}),e}static loopShallowEls(t,e){let n=[...t].reverse();for(;n.length>0;){let i=n.pop();"_$dlNodeType"in i?i._$nodes&&n.push(...[...i._$nodes].reverse()):e(i)}}static addParentEl(t,e){t.forEach(n=>{"_$dlNodeType"in n&&(n._$parentEl=e,n._$nodes&&l.addParentEl(n._$nodes,e))})}static getFlowIndexFromNodes(t,e){let n=0,i=[...t].reverse();for(;i.length>0;){let s=i.pop();if(s===e)break;"_$dlNodeType"in s?s._$nodes&&i.push(...[...s._$nodes].reverse()):n++}return n}static appendNodesWithSibling(t,e,n){return n?this.insertNodesBefore(t,e,n):this.appendNodes(t,e)}static appendNodesWithIndex(t,e,n,i){return i=i??e.childNodes.length,i!==n?this.insertNodesBefore(t,e,e.childNodes[n]):this.appendNodes(t,e)}static insertNodesBefore(t,e,n){let i=0;return this.loopShallowEls(t,s=>{e.insertBefore(s,n),i++}),i}static appendNodes(t,e){let n=0;return this.loopShallowEls(t,i=>{e.appendChild(i),n++}),n}static addWillUnmount(t,e){let n=r.global.WillUnmountStore,i=n[n.length-1];i&&i.push(e.bind(null,t))}static addDidUnmount(t,e){let n=r.global.DidUnmountStore,i=n[n.length-1];i&&i.push(e.bind(null,t))}static addDidMount(t,e){r.global.DidMountStore||(r.global.DidMountStore=[]),r.global.DidMountStore.push(e.bind(null,t))}static runDidMount(){let t=r.global.DidMountStore;if(!(!t||t.length===0)){for(let e=t.length-1;e>=0;e--)t[e]();r.global.DidMountStore=[]}}};function K(o,t,e){if(e.length===0)return!1;let n=`$${t}`;return g(e,o[n])?!0:(o[n]=e,!1)}var P=o=>o.startsWith("--");function A(o,t){let e=o.style,n=o._prevStyle||{};for(let i in n)n.hasOwnProperty(i)&&(t==null||!t.hasOwnProperty(i))&&(P(i)?e.removeProperty(i):i==="float"?e.cssFloat="":e[i]="");for(let i in t){let s=n[i],d=t[i];t.hasOwnProperty(i)&&d!==s&&(d==null||d===""||typeof d=="boolean"?P(i)?e.removeProperty(i):i==="float"?e.cssFloat="":e[i]="":P(i)?e.setProperty(i,t):i==="float"?e.cssFloat=t:o.style[i]=d)}o._prevStyle={...t}}function B(o,t){Object.assign(o.dataset,t)}function V(o,t,e,n){K(o,t,n)||(o[t]=e())}function X(o,t){Object.entries(t).forEach(([e,n])=>{if(e==="style")return A(o,n);if(e==="dataset")return B(o,n);V(o,e,()=>n,[])})}function O(o,t,e,n){K(o,t,n)||o.setAttribute(t,e())}function Z(o,t){Object.entries(t).forEach(([e,n])=>{O(o,e,()=>n,[])})}function k(o,t,e){let n=o[`$on${t}`];n&&o.removeEventListener(t,n),o.addEventListener(t,e),o[`$on${t}`]=e}function tt(o){let t=`$$${o.type}`;for(let e of o.composedPath())if(e[t]&&e[t](o),o.cancelBubble)return}function ht(o,t,e){o[`$$${t}`]!==e&&(o[`$$${t}`]=e,r.delegatedEvents.has(t)||(r.delegatedEvents.add(t),r.document.addEventListener(t,tt)))}function at(o){return r.document.createElement(o)}function F(o,t,e){o._$nodes||(o._$nodes=Array.from(o.childNodes)),o._$nodes.splice(e,0,t);let n=l.getFlowIndexFromNodes(o._$nodes,t);l.appendNodesWithIndex([t],o,n),l.addParentEl([t],o)}function j(o,t,e,n){if(t==="style")return A(o,e());if(t==="dataset")return B(o,e());if(t!=="element"){if(t==="prop")return X(o,e());if(t==="attr")return Z(o,e());if(t==="innerHTML")return V(o,"innerHTML",e,n);if(t==="textContent")return V(o,"textContent",e,n);if(t!=="forwardProp"){if(t.startsWith("on"))return k(o,t.slice(2).toLowerCase(),e());O(o,t,e,n)}}}var et=Promise.resolve();function z(o){et.then(o)}var b=class extends l{constructor(){super(m.Comp)}setUpdateFunc({updateState:t,updateProp:e,updateContext:n,getUpdateViews:i,didUnmount:s,willUnmount:d,didMount:h}){this.updateState=t,this._$updateProp=e,n&&(this.updateContext=n),this.getUpdateViews=i,this.didUnmount=s,this.willUnmount=d,this.didMount=h}updateProp(...t){this._$updateProp(...t)}init(){this._$notInitd=!0;let t=()=>{if(this._$callUpdatesBeforeInit(),this.didMount&&l.addDidMount(this,this.didMount.bind(this)),this.willUnmount&&l.addWillUnmount(this,this.willUnmount.bind(this)),l.addDidUnmount(this,this._$setUnmounted.bind(this)),this.didUnmount&&l.addDidUnmount(this,this.didUnmount.bind(this)),this.getUpdateViews){let e=this.getUpdateViews();if(Array.isArray(e)){let[n,i]=e;this.updateView=i,this._$nodes=n}else this.updateView=e}};return this._$catchable?(this._$catchable(t)(),this._$update&&(this._$update=this._$catchable(this._$update.bind(this))),this.updateDerived=this._$catchable(this.updateDerived.bind(this)),delete this._$catchable):t(),this}_$setUnmounted(){this._$unmounted=!0}_$callUpdatesBeforeInit(){this.updateState(-1),delete this._$notInitd}_$setPropToForward(t,e,n){this._$forwardPropsSet.forEach(i=>{if(i._$dlNodeType===m.Comp){i._$setProp(t,()=>e,n);return}i instanceof HTMLElement&&j(i,t,()=>e,n)})}_$setForwardProp(t,e,n){let i="_$notInitd"in this;if(!i&&this._$cache(t,n))return;let s=e();t==="_$content"&&this._$contentKey&&(this[this._$contentKey]=s,this.updateDerived(this._$contentKey)),this[t]=s,this.updateDerived(t),i?this._$forwardPropsId.push(t):this._$setPropToForward(t,s,n)}_$cache(t,e){if(!e||!e.length)return!1;let n=`$cc$${t}`;return g(e,this[n])?!0:(this[n]=e,!1)}_$setContent(t,e){if("_$forwardProps"in this)return this._$setForwardProp("_$content",t,e);let n=this._$contentKey;n&&(this._$cache(n,e)||(this[n]=t(),this.updateDerived(n)))}_$setProp(t,e,n){this._$cache(t,n)||(this[t]=e(),this.updateProp(t,this[t]))}_$setProps(t,e){if(this._$cache("props",e))return;let n=t();n&&Object.entries(n).forEach(([i,s])=>{this._$setProp(i,()=>s,[])})}_$updateContext(t,e,n){this.updateContext&&this.updateContext(n,t,e)}_$ud(t,e){return this.updateDerived(e),t}updateDerived(t,e){"_$notInitd"in this||(this.updateState(e),I()||this._$updateView(e))}_$updateView(t){t&&("_$depNumsToUpdate"in this?this._$depNumsToUpdate.push(t):(this._$depNumsToUpdate=[t],z(()=>{if(this._$unmounted)return;let e=this._$depNumsToUpdate;if(e.length>0){let n=e.reduce((i,s)=>i|s,0);this.updateView(n)}delete this._$depNumsToUpdate})))}},xt=b;function Ut(o,t){o.updateDerived(t)}var L=class extends b{constructor(t,e){super(),this.parent=t,this.bitMap=e}updateHook(t,e){this.update()}emitUpdate(){this.parent.updateDerived(null,this.bitMap)}setUpdateFunc({value:t,...e}){super.setUpdateFunc(e),this.value=t}updateProp(...t){I()||super.updateProp(...t)}};var T=class extends l{constructor(t,e,n){super(m.Env),"DLEnvStore"in r.global||(r.global.envNodeMap=new Map),this.context=t,this.envs=e,this.depsArr=n,this.updateNodes=new Set,this.replaceContextValue()}cached(t,e){return!t||!t.length?!1:g(t,this.depsArr[e])?!0:(this.depsArr[e]=t,!1)}updateContext(t,e,n){if(this.cached(n,t))return;let i=e();this.envs[t]=i,this.updateNodes.forEach(s=>{s._$updateContext(t,i,this.context)})}replaceContextValue(){this.prevValue=this.context.value,this.prevEnvNode=r.global.envNodeMap.get(this.context.id),this.context.value=this.envs,r.global.envNodeMap.set(this.context.id,this)}addNode(t){this.updateNodes.add(t),l.addWillUnmount(t,this.updateNodes.delete.bind(this.updateNodes,t))}initNodes(t){this._$nodes=t,this.context.value=this.prevValue,this.prevEnvNode?r.global.envNodeMap.set(this.context.id,this.prevEnvNode):r.global.envNodeMap.delete(this.context.id),this.prevValue=null,this.prevEnvNode=null}};function H(o){for(let[t,e]of o.entries())e.replaceContextValue()}function yt(o,t){let e=r.document.createTextNode(o);return e.$$deps=t,e}function Ft(o,t,e){if(g(e,o.$$deps))return;let n=t();o.textContent=n,o.$$deps=e}var q=class{propViewFunc;dlUpdateFunc=new Set;constructor(t){this.propViewFunc=t}build(){let t,e=i=>{t=i,this.dlUpdateFunc.add(i)},n=this.propViewFunc(e);return n.length===0?[]:(t&&l.addWillUnmount(n[0],this.dlUpdateFunc.delete.bind(this.dlUpdateFunc,t)),n)}update(...t){this.dlUpdateFunc.forEach(e=>{e(...t)})}};function Wt(o,t){F(o,{_$nodes:t.build(),_$dlNodeType:7},0)}var D=class extends l{constructor(t){super(t);let e=r.global.envNodeMap;e&&(this.savedEnvNodes=new Map([...e]))}initNewNodes(t){l.addParentEl(t,this._$parentEl)}geneNewNodesInEnv(t){if(!this.savedEnvNodes){let i=t();return this.initNewNodes(i),i}let e=r.global.envNodeMap;H(this.savedEnvNodes);let n=t();return H(e),this.initNewNodes(n),n}initUnmountStore(){r.global.WillUnmountStore.push([]),r.global.DidUnmountStore.push([])}removeNodes(t){l.loopShallowEls(t,e=>{this._$parentEl.removeChild(e)})}};var p=class extends D{array;nodeFunc;depNum;nodesMap=new Map;updateArr=[];get _$nodes(){let t=[];for(let e=0;e<this.array.length;e++)t.push(...this.nodesMap.get(this.keys?.[e]??e));return t}constructor(t,e,n,i){super(m.For),this.array=[...t],this.keys=n,this.depNum=e,this.addNodeFunc(i)}addNodeFunc(t){this.nodeFunc=t,this.array.forEach((e,n)=>{this.initUnmountStore();let i=this.keys?.[n]??n,s=t(e,n,this.updateArr);this.nodesMap.set(i,s),this.setUnmountMap(i)}),p.addWillUnmount(this,this.runAllWillUnmount.bind(this)),p.addDidUnmount(this,this.runAllDidUnmount.bind(this))}updateItem(t,e,n){this.updateArr[t]?.(n??this.depNum,e[t])}updateItems(t){for(let e=0;e<this.array.length;e++)this.updateItem(e,this.array,t)}update(t){~this.depNum&t&&this.updateItems(t)}updateArray(t,e){if(e){this.updateWithKey(t,e);return}this.updateWithOutKey(t)}getNewNodes(t,e,n,i){this.initUnmountStore();let s=this.geneNewNodesInEnv(()=>this.nodeFunc(n[t],t,i??this.updateArr));return this.setUnmountMap(e),this.nodesMap.set(e,s),s}setUnmountMap(t){let e=r.global.WillUnmountStore.pop();e&&e.length>0&&(this.willUnmountMap||(this.willUnmountMap=new Map),this.willUnmountMap.set(t,e));let n=r.global.DidUnmountStore.pop();n&&n.length>0&&(this.didUnmountMap||(this.didUnmountMap=new Map),this.didUnmountMap.set(t,n))}runAllWillUnmount(){!this.willUnmountMap||this.willUnmountMap.size===0||(this.willUnmountMap.forEach(t=>{for(let e=0;e<t.length;e++)t[e]?.()}),this.willUnmountMap.clear())}runAllDidUnmount(){!this.didUnmountMap||this.didUnmountMap.size===0||(this.didUnmountMap.forEach(t=>{for(let e=t.length-1;e>=0;e--)t[e]?.()}),this.didUnmountMap.clear())}runWillUnmount(t){if(!this.willUnmountMap||this.willUnmountMap.size===0)return;let e=this.willUnmountMap.get(t);if(e){for(let n=0;n<e.length;n++)e[n]?.();this.willUnmountMap.delete(t)}}runDidUnmount(t){if(!this.didUnmountMap||this.didUnmountMap.size===0)return;let e=this.didUnmountMap.get(t);if(e){for(let n=e.length-1;n>=0;n--)e[n]?.();this.didUnmountMap.delete(t)}}removeNodes(t,e){this.runWillUnmount(e),super.removeNodes(t),this.runDidUnmount(e),this.nodesMap.delete(e)}updateWithOutKey(t){let e=this.array.length,n=t.length;if(e===n){for(let s=0;s<this.array.length;s++)this.updateItem(s,t);this.array=[...t];return}let i=this._$parentEl;if(e<n){let s=p.getFlowIndexFromNodes(i._$nodes,this),d=i.childNodes.length;for(let h=0;h<n;h++){if(h<e){s+=p.getFlowIndexFromNodes(this.nodesMap.get(h)),this.updateItem(h,t);continue}let v=this.getNewNodes(h,h,t);p.appendNodesWithIndex(v,i,s,d)}p.runDidMount(),this.array=[...t];return}for(let s=0;s<n;s++)this.updateItem(s,t);for(let s=n;s<e;s++){let d=this.nodesMap.get(s);this.removeNodes(d,s)}this.updateArr.splice(n,e-n),this.array=[...t]}updateWithKey(t,e){if(e.length!==new Set(e).size)throw new Error("Inula-Next: Duplicate keys in for loop are not allowed");let n=this.keys;if(this.keys=e,p.arrayEqual(n,this.keys)){for(let u=0;u<t.length;u++)this.updateItem(u,t);this.array=[...t];return}let i=this._$parentEl;if(this.keys.length===0){let u=i._$nodes??[];if(u.length===1&&u[0]===this)this.runAllWillUnmount(),i.innerHTML="",this.runAllDidUnmount();else for(let a=0;a<n.length;a++){let f=n[a];this.removeNodes(this.nodesMap.get(f),f)}this.nodesMap.clear(),this.updateArr=[],this.array=[];return}let s=p.getFlowIndexFromNodes(i._$nodes,this);if(n.length===0){let u=i.childNodes[s];for(let a=0;a<this.keys.length;a++){let f=this.getNewNodes(a,this.keys[a],t);p.appendNodesWithSibling(f,i,u)}p.runDidMount(),this.array=[...t];return}let d=[],h=[];for(let u=0;u<n.length;u++){let a=n[u];if(this.keys.includes(a)){d.push(a),h.push(this.updateArr[u]);continue}this.removeNodes(this.nodesMap.get(a),a)}let v=i.childNodes.length,x=s;for(let u=0;u<this.keys.length;u++){let a=this.keys[u],f=d.indexOf(a);if(f!==-1){x+=p.getFlowIndexFromNodes(this.nodesMap.get(a)),h[f]?.(this.depNum,t[u]);continue}h.splice(u,0,null);let M=this.getNewNodes(u,a,t,h);d.splice(u,0,a);let y=p.appendNodesWithIndex(M,i,x,v);x+=y,v+=y}if(p.runDidMount(),p.arrayEqual(this.keys,d)){this.array=[...t],this.updateArr=h;return}x=s;let W=new Map;for(let u=0;u<this.keys.length;u++){let a=this.keys[u],f=d.indexOf(a),M=W.get(a);if(M){let E=p.getFlowIndexFromNodes(M),S=p.toEls(M).pop(),_=i.childNodes[x+E];S!==_&&S.nextSibling!==_&&p.insertNodesBefore(M,i,_),x+=E,delete W[u]}else if(f===u){x+=p.getFlowIndexFromNodes(this.nodesMap.get(a));continue}else{let E=d[u];W.set(E,this.nodesMap.get(E));let S=this.nodesMap.get(a),_=p.toEls(S).pop(),C=i.childNodes[x];_!==C&&_.nextSibling!==C&&(x+=p.insertNodesBefore(S,i,C))}let y=d[u];d[u]=d[f],d[f]=y;let J=h[u];h[u]=h[f],h[f]=J}this.array=[...t],this.updateArr=h}static arrayEqual(t,e){return t.length!==e.length?!1:t.every((n,i)=>n===e[i])}};var N=class extends D{willUnmountFuncs=[];didUnmountFuncs=[];setUnmountFuncs(){this.willUnmountFuncs=r.global.WillUnmountStore.pop(),this.didUnmountFuncs=r.global.DidUnmountStore.pop()}runWillUnmount(){for(let t=0;t<this.willUnmountFuncs.length;t++)this.willUnmountFuncs[t]()}runDidUnmount(){for(let t=this.didUnmountFuncs.length-1;t>=0;t--)this.didUnmountFuncs[t]()}removeNodes(t){this.runWillUnmount(),super.removeNodes(t),this.runDidUnmount()}geneNewNodesInEnv(t){this.initUnmountStore();let e=super.geneNewNodesInEnv(t);return this.setUnmountFuncs(),e}};var $=class extends N{constructor(t,e){super(m.Exp),this.initUnmountStore(),this._$nodes=$.formatNodes(t),this.setUnmountFuncs(),this.deps=this.parseDeps(e),$.addWillUnmount(this,this.runWillUnmount.bind(this)),$.addDidUnmount(this,this.runDidUnmount.bind(this))}parseDeps(t){return t.map(e=>e?.prototype?._$init?e.toString():e?.propViewFunc?e.propViewFunc.toString():e)}cache(t){return!t||!t.length?!1:(t=this.parseDeps(t),g(t,this.deps)?!0:(this.deps=t,!1))}update(t,e){if(this.cache(e))return;this.removeNodes(this._$nodes);let n=this.geneNewNodesInEnv(()=>$.formatNodes(t()));if(n.length===0){this._$nodes=[];return}let i=this._$parentEl,s=$.getFlowIndexFromNodes(i._$nodes,this),d=i.childNodes[s];$.appendNodesWithSibling(n,i,d),$.runDidMount(),this._$nodes=n}static formatNodes(t){return Array.isArray(t)||(t=[t]),t.flat(1).filter(e=>e!=null&&typeof e!="boolean").map(e=>typeof e=="string"||typeof e=="number"||typeof e=="bigint"?r.document.createTextNode(`${e}`):"propViewFunc"in e?e.build():e).flat(1)}};var U=class extends N{constructor(t,e){super(m.Cond),this.depNum=t,this.cond=-1,this.condFunc=e,this.initUnmountStore(),this._$nodes=this.condFunc(this),this.setUnmountFuncs(),U.addWillUnmount(this,this.runWillUnmount.bind(this)),U.addDidUnmount(this,this.runDidUnmount.bind(this))}updateCond(t){let e=[this.willUnmountFuncs,this.didUnmountFuncs],n=this.geneNewNodesInEnv(()=>this.condFunc(this));if(this.didntChange){[this.willUnmountFuncs,this.didUnmountFuncs]=e,this.didntChange=!1,this.updateFunc?.(this.depNum,t);return}let i=[this.willUnmountFuncs,this.didUnmountFuncs];if([this.willUnmountFuncs,this.didUnmountFuncs]=e,this._$nodes&&this._$nodes.length>0&&this.removeNodes(this._$nodes),[this.willUnmountFuncs,this.didUnmountFuncs]=i,n.length===0){this._$nodes=[];return}let s=this._$parentEl,d=U.getFlowIndexFromNodes(s._$nodes,this),h=s.childNodes[d];U.appendNodesWithSibling(n,s,h),U.runDidMount(),this._$nodes=n}update(t){~this.depNum&t&&this.updateFunc?.(t)}};var G=class extends N{constructor(t,e){super(m.Try),this.tryFunc=t;let n=this.getCatchable(e);this.envNode=new T({_$catchable:n});let i=t(this.setUpdateFunc.bind(this),n)??[];this.envNode.initNodes(i),this._$nodes=i}update(t){this.updateFunc?.(t)}setUpdateFunc(t){this.updateFunc=t}getCatchable(t){return e=>(...n)=>{try{return e(...n)}catch(i){Promise.resolve().then(()=>{let s=this.geneNewNodesInEnv(()=>t(this.setUpdateFunc.bind(this),i));this._$nodes&&this.removeNodes(this._$nodes);let d=this._$parentEl,h=N.getFlowIndexFromNodes(d._$nodes,this),v=d.childNodes[h];N.appendNodesWithSibling(s,d,v),N.runDidMount(),this._$nodes=s})}}}};function nt(){r.global.WillUnmountStore=[],r.global.DidUnmountStore=[]}function le(o,t){let e=t;if(typeof t=="string"){let i=r.document.getElementById(t);if(i)e=i;else throw new Error(`Inula-Next: Element with id ${t} not found`)}nt(),e.innerHTML="";let n=ot(o);F(e,n,0),l.runDidMount()}function he(o){return o()}var ae=null;function pe(){console.error("Inula-Next: use() is not supported be called directly. You can only assign `use(model)` to a Inula-Next class property. Any other expressions are not allowed.")}var c=null;function I(){return!!c}function ot(o,t={}){return Y(()=>new b,o,t)}function Y(o,t,e){let n=o(),i=c;try{c=n,t(e)}catch(s){throw s}finally{c=i}return n}function ce(o){if(!c)throw new Error("Should not call createComponent outside the component function");return c.setUpdateFunc(o),c}function fe(o,t,e){return!e||!e.length?!1:(o.$nonkeyedCache||(o.$nonkeyedCache={}),g(e,o.$nonkeyedCache[t])?(o.$nonkeyedCache[t]=e,!1):!0)}function me(){throw new Error("lifecycle should be compiled, check the babel plugin")}function ge(){throw new Error("lifecycle should be compiled, check the babel plugin")}function Ne(){throw new Error("lifecycle should be compiled, check the babel plugin")}function $e(o){return{id:Symbol("inula-ctx"),value:o}}function xe(o,t){let e=r.global.envNodeMap;if(e){let n=e.get(o.id);n&&n.addNode(c)}return t?o.value[t]:o.value}function Ue(o,t,e){if(c){let n=t.reduce((i,s,d)=>({...i,[`p${d}`]:s}),{});return Y(()=>new L(c,e),o,n)}}function we(o){if(!c)throw new Error("Should not call createComponent outside the component function");return c.setUpdateFunc(o),c}function be(o){c&&o()}export{ot as Comp,b as CompNode,U as CondNode,T as ContextProvider,$ as ExpNode,p as ForNode,q as PropView,G as TryNode,xt as View,ce as createComponent,$e as createContext,at as createElement,we as createHook,yt as createTextNode,ht as delegateEvent,me as didMount,Ne as didUnMount,j as forwardHTMLProp,I as inMount,Wt as insertChildren,F as insertNode,fe as notCached,le as render,H as replaceEnvNodes,ae as required,be as runOnce,B as setDataset,R as setDocument,k as setEvent,Q as setGlobal,O as setHTMLAttr,Z as setHTMLAttrs,V as setHTMLProp,X as setHTMLProps,A as setStyle,he as untrack,Ut as update,Ft as updateText,pe as use,xe as useContext,Ue as useHook,ge as willUnmount};
//# sourceMappingURL=index.js.map